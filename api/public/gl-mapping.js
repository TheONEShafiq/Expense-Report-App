async function fetchJSON(url){ const r=await fetch(url); if(!r.ok) throw new Error(await r.text()); return r.json(); }
async function postJSON(url, body){ const r=await fetch(url,{ method:'POST', headers:{ 'Content-Type':'application/json', 'X-Actor-Email': localStorage.getItem('actorEmail') || '' }, body: JSON.stringify(body)}); if(!r.ok) throw new Error(await r.text()); return r.json(); }
const selCompany = document.getElementById('company'); const glTblBody = document.querySelector('#glTbl tbody'); const mapTblBody = document.querySelector('#mapTbl tbody');
let categories=[], accounts=[], mappings=[];
async function loadCompanies(){ const { data } = await fetchJSON('/admin/companies'); selCompany.innerHTML = data.map(c=>`<option value="${c.id}">${c.name}</option>`).join(''); const storedCompany=localStorage.getItem('companyId'); if(storedCompany){ selCompany.value = storedCompany; } }
async function loadData(){ const companyId = selCompany.value; localStorage.setItem('companyId', companyId); const { data } = await fetchJSON(`/admin/gl?company_id=${companyId}`); categories = data.categories; accounts = data.accounts; mappings = data.mappings; renderAccounts(); renderMappings(); }
function renderAccounts(){ glTblBody.innerHTML = accounts.map(a => `<tr data-id="${a.id}"><td>${a.number||''}</td><td>${a.name}</td><td>${a.active?'Yes':'No'}</td></tr>`).join(''); }
function renderMappings(){ const mapByCat = Object.fromEntries(mappings.map(m => [m.categoryId, m.glAccountId])); mapTblBody.innerHTML = categories.map(cat => { const glOpts = accounts.map(a => `<option value="${a.id}" ${mapByCat[cat.id]===a.id?'selected':''}>${a.number? a.number+' Â· ':''}${a.name}</option>`).join(''); return `<tr data-cat="${cat.id}"><td>${cat.name}</td><td><select>${glOpts}</select></td></tr>`; }).join(''); }
document.getElementById('addGl').onclick = async () => { const name = (document.getElementById('glName')).value.trim(); const number = (document.getElementById('glNum')).value.trim(); if(!name){ alert('Name required'); return; } const companyId = selCompany.value; await postJSON('/admin/gl/accounts', { companyId, name, number }); await loadData(); (document.getElementById('glName')).value = ''; (document.getElementById('glNum')).value = ''; };
document.getElementById('saveMap').onclick = async () => { const companyId = selCompany.value; const items = Array.from(mapTblBody.querySelectorAll('tr')).map(tr => ({ categoryId: tr.dataset.cat, glAccountId: tr.querySelector('select').value })); await postJSON('/admin/gl/mappings', { companyId, items }); alert('Mappings saved.'); await loadData(); };
selCompany.addEventListener('change', loadData); loadCompanies().then(loadData).catch(e => alert(e.message));
