async function fetchJSON(url, actor){ const r=await fetch(url,{ headers: actor?{'X-Actor-Email':actor}:{}}); if(!r.ok) throw new Error(await r.text()); return r.json(); }
async function postJSON(url, body, actor){ const r=await fetch(url,{ method:'POST', headers:{ 'Content-Type':'application/json', ...(actor?{'X-Actor-Email':actor}:{}) }, body: JSON.stringify(body)}); if(!r.ok) throw new Error(await r.text()); return r.json(); }

const els = { actor: document.getElementById('actorEmail'), company: document.getElementById('companySel'), queue: document.getElementById('queue'), reportMeta: document.getElementById('reportMeta'), linesBody: document.querySelector('#linesTbl tbody'), };
let selectedReportId = null;

async function loadCompanies(){ const j = await fetchJSON('/admin/companies'); els.company.innerHTML = j.data.map(c => `<option value="${c.id}">${c.name}</option>`).join(''); const storedCompany=localStorage.getItem('companyId'); if(storedCompany){ els.company.value = storedCompany; } }
async function loadQueue(){ const actor = els.actor.value.trim() || localStorage.getItem('actorEmail'); if(!actor) return; const j = await fetchJSON(`/approver/queue?company_id=${els.company.value}`, actor); const items = j.data; els.queue.textContent = JSON.stringify(items, null, 2); if (items.length) { selectedReportId = items[0].reportId; await loadLines(); } }
async function loadLines(){ const actor = els.actor.value.trim() || localStorage.getItem('actorEmail'); if(!actor||!selectedReportId) return; const j = await fetchJSON(`/approver/reports/${selectedReportId}/lines`, actor); els.reportMeta.textContent = JSON.stringify(j.data.report, null, 2); const rep = j.data.report; const link = document.createElement('a'); link.href=`/export-preview.html#${rep.id}`; link.textContent='Open Export Preview'; link.target='_blank'; els.reportMeta.appendChild(document.createElement('br')); els.reportMeta.appendChild(link); els.linesBody.innerHTML = j.data.lines.map(line => { const b = (s)=>`<span class="badge b-${s}">${s}</span>`; return `<tr data-id="${line.id}"><td>${String(line.date).slice(0,10)}</td><td>${line.merchant}</td><td>${line.category}</td><td>$${Number(line.amountUsd).toFixed(2)}</td><td>${line.attendeesCount ?? 1}</td><td>${b(line.policyStatus)}</td><td>${b(line.lineStatus)}</td><td>${line.lineStatus==='pending'?`<button data-dec="approved">Approve</button><button data-dec="rejected">Reject</button>`:'â€”'}</td></tr>`; }).join(''); els.linesBody.querySelectorAll('button[data-dec]').forEach(btn => { btn.addEventListener('click', async () => { const actor = els.actor.value.trim() || localStorage.getItem('actorEmail'); const lineId = btn.closest('tr').dataset.id; await postJSON(`/approver/reports/${selectedReportId}/lines/${lineId}/decision`, { decision: btn.dataset.dec }, actor); await loadQueue(); await loadLines(); }); }); }
els.company.addEventListener('change', () => { localStorage.setItem('companyId', els.company.value); selectedReportId = null; loadQueue(); }); els.actor.addEventListener('change', () => { localStorage.setItem('actorEmail', els.actor.value.trim()); selectedReportId = null; loadQueue(); });
loadCompanies().then(loadQueue).catch(e => alert(e.message));
